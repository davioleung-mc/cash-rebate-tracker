<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Test - Cash Rebate Explorer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .loading {
            color: #666;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Connection Diagnostic Tool</h1>
        <p>This tool will help diagnose connection issues with the Cash Rebate Explorer.</p>
        
        <div id="results">
            <div class="test-result info">
                <strong>Loading diagnostic tests...</strong>
            </div>
        </div>
        
        <button onclick="runTests()">üîÑ Run Tests Again</button>
        <button onclick="window.location.href='index.html'">üîç Back to Explorer</button>
    </div>

    <!-- Load ethers.js -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    
    <!-- Load our config -->
    <script src="config.js"></script>
    
    <script>
        let results = [];
        
        function addResult(type, title, message, details = '') {
            results.push({ type, title, message, details });
            updateDisplay();
        }
        
        function updateDisplay() {
            const container = document.getElementById('results');
            container.innerHTML = results.map(result => `
                <div class="test-result ${result.type}">
                    <strong>${result.title}</strong><br>
                    ${result.message}
                    ${result.details ? `<br><small>${result.details}</small>` : ''}
                </div>
            `).join('');
        }
        
        async function runTests() {
            results = [];
            addResult('info', 'üîÑ Starting Tests', 'Running diagnostic tests...');
            
            // Test 1: Check if ethers.js loaded
            try {
                if (typeof ethers !== 'undefined') {
                    addResult('success', '‚úÖ ethers.js Library', 'Successfully loaded');
                } else {
                    addResult('error', '‚ùå ethers.js Library', 'Library not loaded');
                    return;
                }
            } catch (error) {
                addResult('error', '‚ùå ethers.js Library', 'Error checking library', error.message);
                return;
            }
            
            // Test 2: Check config
            try {
                if (typeof CONFIG !== 'undefined' && CONFIG.contractAddress) {
                    addResult('success', '‚úÖ Configuration', `Contract: ${CONFIG.contractAddress}`);
                } else {
                    addResult('error', '‚ùå Configuration', 'Config not loaded properly');
                    return;
                }
            } catch (error) {
                addResult('error', '‚ùå Configuration', 'Error loading config', error.message);
                return;
            }
            
            // Test 3: Test RPC connections
            for (let i = 0; i < CONFIG.network.rpcUrls.length; i++) {
                const rpcUrl = CONFIG.network.rpcUrls[i];
                try {
                    addResult('info', 'üîó Testing RPC', `Trying endpoint ${i + 1}: ${rpcUrl}`);
                    
                    const provider = new ethers.providers.JsonRpcProvider(rpcUrl);
                    
                    // Test with timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    const network = await Promise.race([
                        provider.getNetwork(),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout after 5s')), 5000)
                        )
                    ]);
                    
                    clearTimeout(timeoutId);
                    
                    if (network && network.chainId) {
                        addResult('success', `‚úÖ RPC Endpoint ${i + 1}`, 
                            `Connected successfully`, 
                            `Chain ID: ${network.chainId}, Name: ${network.name || 'Unknown'}`);
                        
                        // Test contract connection
                        try {
                            const contract = new ethers.Contract(
                                CONFIG.contractAddress,
                                ['function getTotalRecords() view returns (uint256)'],
                                provider
                            );
                            
                            const totalRecords = await contract.getTotalRecords();
                            addResult('success', '‚úÖ Contract Connection', 
                                `Contract accessible`, 
                                `Total records: ${totalRecords.toString()}`);
                            
                            // If we get here, everything works!
                            addResult('success', 'üéâ All Tests Passed', 
                                'Your explorer should work correctly!', 
                                'If you\'re still seeing errors, try refreshing the main page.');
                            return;
                            
                        } catch (contractError) {
                            addResult('error', '‚ùå Contract Connection', 
                                'Contract not accessible', 
                                contractError.message);
                        }
                    }
                    
                } catch (rpcError) {
                    addResult('error', `‚ùå RPC Endpoint ${i + 1}`, 
                        'Connection failed', 
                        rpcError.message);
                }
            }
            
            addResult('error', 'üö´ All Tests Failed', 
                'Unable to connect to any RPC endpoint', 
                'This might be a temporary network issue. Try again later.');
        }
        
        // Run tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html>